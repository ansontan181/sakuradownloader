<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>m3u8 ä¸€é”®ä¸‹è½½</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:24px;background:#0b1020;color:#e8ebff}
    h1{font-size:20px;margin:0 0 12px}
    .card{background:#121735;border:1px solid #283063;border-radius:14px;padding:16px;max-width:980px;margin:auto}
    textarea{width:100%;min-height:200px;border:1px solid #39427f;background:#0f1430;color:#dbe1ff;border-radius:10px;padding:12px;font-size:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    button{border:0;background:#4c7dff;color:#fff;padding:10px 16px;border-radius:10px;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    #log{margin-top:12px;padding:12px;background:#0f1430;border:1px solid #39427f;border-radius:10px;height:240px;overflow:auto;white-space:pre-wrap}
    .hint{opacity:.8;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
  <div class="card">
    <h1>m3u8 ä¸€é”®ä¸‹è½½ï¼ˆRender åç«¯ç‰ˆï¼‰</h1>
    <div class="hint">åœ¨ä¸‹é¢ç²˜è´´<b>è§†é¢‘ç½‘é¡µé“¾æ¥</b>ï¼ˆä¸æ˜¯ m3u8ï¼‰ã€‚åç«¯ä¼šè‡ªåŠ¨æŠ“å– m3u8 å¹¶ä¸‹è½½ MP4ã€‚</div>

    <textarea id="urls" placeholder="æ¯è¡Œä¸€ä¸ªç½‘é¡µé“¾æ¥"></textarea>

    <div class="row">
      <button id="go" onclick="start()">ğŸš€ å¼€å§‹å¹¶æ˜¾ç¤ºè¿›åº¦</button>
      <button id="dl" onclick="downloadResult()" disabled>ä¸‹è½½ç»“æœ</button>
    </div>

    <pre id="log"></pre>
  </div>

<script>
/** â†â† è¿™é‡Œå·²æ›¿ä½ å¡«å¥½ Render åŸŸå */
const API_BASE = 'https://sakuradownloader-mo6n.onrender.com';

let es = null;

function log(msg){
  const box = document.getElementById('log');
  box.textContent += msg + '\n';
  box.scrollTop = box.scrollHeight;
}
function setBtn(b, txt, dis){ b.innerText = txt; b.disabled = !!dis; }

async function start(){
  const btn = document.getElementById('go');
  const dl  = document.getElementById('dl');
  const urls = document.getElementById('urls').value.trim();
  document.getElementById('log').textContent = '';
  dl.disabled = true; dl.removeAttribute('data-href');

  if(!urls){ alert('è¯·ç²˜è´´è‡³å°‘ä¸€ä¸ªé“¾æ¥'); return; }

  setBtn(btn, 'å¤„ç†ä¸­â€¦', true);
  try{
    // 1) åˆ›å»ºä»»åŠ¡
    const res = await fetch(`${API_BASE}/oneclick_start`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ urls })
    });
    if(!res.ok){
      log('åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼š' + (await res.text()));
      setBtn(btn, 'ğŸš€ å¼€å§‹å¹¶æ˜¾ç¤ºè¿›åº¦', false);
      return;
    }
    const { job_id } = await res.json();
    log('ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼š' + job_id);

    // 2) è¿æ¥ SSE æ—¥å¿—æµ
    es = new EventSource(`${API_BASE}/oneclick_stream/${job_id}`);
    es.onmessage = (ev)=> log(ev.data);
    es.addEventListener('done', (ev)=>{
      const href = ev.data;  // æœåŠ¡ç«¯è¿”å›å½¢å¦‚ /artifact/<job_id>
      log('âœ… å®Œæˆï¼Œç‚¹å‡»â€œä¸‹è½½ç»“æœâ€æŒ‰é’®ã€‚');
      dl.dataset.href = href;
      dl.disabled = false;
      es.close();
      setBtn(btn, 'ğŸš€ å¼€å§‹å¹¶æ˜¾ç¤ºè¿›åº¦', false);
    });
    es.addEventListener('error', ()=>{
      log('âŒ æµè¿æ¥å¼‚å¸¸æˆ–è¢«å…³é—­');
      try{ es.close(); }catch(_){}
      setBtn(btn, 'ğŸš€ å¼€å§‹å¹¶æ˜¾ç¤ºè¿›åº¦', false);
    });
  }catch(e){
    log('âŒ è¯·æ±‚å¼‚å¸¸ï¼š' + e);
    setBtn(btn, 'ğŸš€ å¼€å§‹å¹¶æ˜¾ç¤ºè¿›åº¦', false);
  }
}

function downloadResult(){
  const href = document.getElementById('dl').dataset.href;
  if(!href){ alert('ç»“æœæœªå°±ç»ª'); return; }
  window.location.href = `${API_BASE}${href}`;
}
</script>
</body>
</html>
